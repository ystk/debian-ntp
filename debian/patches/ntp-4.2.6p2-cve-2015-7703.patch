From: jnperlin@hydra.localnet
Date: Tue, 29 Sep 2015 20:34:05 +0200
Subject: [Bug 2902] configuration directives "pidfile" and "driftfile" should
 be local-only.
Origin: https://github.com/ntp-project/ntp/commit/5dea6ff160c7e8f7cb038619ccccd28c3a8df637

[bwh: Backported:
 - Drop changes to ChangeLog
 - As the parser definition is somewhat different in this version, follow
   what was already done for the "logfile" directive
 - Regenerate the C files using:
       yacc --defines=ntp_parser.h -o ntp_parser.c -t ntp_parser.y
]
---
--- a/ntpd/ntp_parser.y
+++ b/ntpd/ntp_parser.y
@@ -876,7 +876,14 @@ miscellaneous_command
 			{ enqueue(cfgt.vars, create_attr_sval($1, $2)); }
 
 	|	T_Pidfile T_String
-			{ enqueue(cfgt.vars, create_attr_sval($1, $2)); }
+		{
+			if (input_from_file) {
+				enqueue(cfgt.vars, create_attr_sval($1, $2));
+			} else {
+				free($2);
+				yyerror("pidfile remote configuration ignored");
+			}
+		}
 	|	T_Logfile T_String
 		{
 			if (input_from_file)
@@ -916,12 +923,32 @@ miscellaneous_command
 	
 drift_parm
 	:	T_String
-			{ enqueue(cfgt.vars, create_attr_sval(T_Driftfile, $1)); }
+		{
+			if (input_from_file) {
+				enqueue(cfgt.vars, create_attr_sval(T_Driftfile, $1));
+			} else {
+				free($1);
+				yyerror("driftfile remote configuration ignored");
+			}
+		}
 	|	T_String T_Double
-			{ enqueue(cfgt.vars, create_attr_dval(T_WanderThreshold, $2));
-			  enqueue(cfgt.vars, create_attr_sval(T_Driftfile, $1)); }
+		{
+			if (input_from_file) {
+				enqueue(cfgt.vars, create_attr_dval(T_WanderThreshold, $2));
+				enqueue(cfgt.vars, create_attr_sval(T_Driftfile, $1));
+			} else {
+				free($1);
+				yyerror("driftfile remote configuration ignored");
+			}
+		}
 	|	/* Null driftfile,  indicated by null string "\0" */
-			{ enqueue(cfgt.vars, create_attr_sval(T_Driftfile, "\0")); }
+		{
+			if (input_from_file) {
+				enqueue(cfgt.vars, create_attr_sval(T_Driftfile, "\0"));
+			} else {
+				yyerror("driftfile remote configuration ignored");
+			}
+		}
 	;
 
 variable_assign
--- a/ntpd/ntp_parser.c
+++ b/ntpd/ntp_parser.c
@@ -906,14 +906,14 @@ static const yytype_uint16 yyrline[] =
      765,   766,   774,   776,   781,   788,   798,   799,   800,   801,
      802,   803,   804,   820,   824,   825,   829,   830,   831,   832,
      833,   834,   835,   844,   845,   861,   867,   869,   871,   873,
-     875,   878,   880,   891,   893,   895,   905,   907,   909,   911,
-     913,   918,   920,   924,   928,   930,   935,   937,   941,   942,
-     946,   947,   951,   966,   971,   979,   980,   984,   985,   986,
-     987,   991,   992,   993,  1003,  1004,  1008,  1010,  1015,  1017,
-    1021,  1026,  1027,  1031,  1032,  1036,  1045,  1046,  1050,  1051,
-    1060,  1075,  1079,  1080,  1084,  1085,  1089,  1090,  1094,  1099,
-    1103,  1107,  1108,  1112,  1117,  1118,  1122,  1124,  1126,  1128,
-    1130
+     875,   878,   887,   898,   900,   902,   912,   914,   916,   918,
+     920,   925,   934,   945,   955,   957,   962,   964,   968,   969,
+     973,   974,   978,   993,   998,  1006,  1007,  1011,  1012,  1013,
+    1014,  1018,  1019,  1020,  1030,  1031,  1035,  1037,  1042,  1044,
+    1048,  1053,  1054,  1058,  1059,  1063,  1072,  1073,  1077,  1078,
+    1087,  1102,  1106,  1107,  1111,  1112,  1116,  1117,  1121,  1126,
+    1130,  1134,  1135,  1139,  1144,  1145,  1149,  1151,  1153,  1155,
+    1157
 };
 #endif
 
@@ -3200,13 +3200,20 @@ yyreduce:
 
 /* Line 1455 of yacc.c  */
 #line 879 "ntp_parser.y"
-    { enqueue(cfgt.vars, create_attr_sval((yyvsp[(1) - (2)].Integer), (yyvsp[(2) - (2)].String))); }
+    {
+			if (input_from_file) {
+				enqueue(cfgt.vars, create_attr_sval((yyvsp[(1) - (2)].Integer), (yyvsp[(2) - (2)].String)));
+			} else {
+				free((yyvsp[(2) - (2)].String));
+				yyerror("pidfile remote configuration ignored");
+			}
+		}
     break;
 
   case 182:
 
 /* Line 1455 of yacc.c  */
-#line 881 "ntp_parser.y"
+#line 888 "ntp_parser.y"
     {
 			if (input_from_file)
 				enqueue(cfgt.vars,
@@ -3221,21 +3228,21 @@ yyreduce:
   case 183:
 
 /* Line 1455 of yacc.c  */
-#line 892 "ntp_parser.y"
+#line 899 "ntp_parser.y"
     { append_queue(cfgt.logconfig, (yyvsp[(2) - (2)].Queue)); }
     break;
 
   case 184:
 
 /* Line 1455 of yacc.c  */
-#line 894 "ntp_parser.y"
+#line 901 "ntp_parser.y"
     { append_queue(cfgt.phone, (yyvsp[(2) - (2)].Queue)); }
     break;
 
   case 185:
 
 /* Line 1455 of yacc.c  */
-#line 896 "ntp_parser.y"
+#line 903 "ntp_parser.y"
     {
 			if (input_from_file)
 				enqueue(cfgt.vars,
@@ -3250,120 +3257,140 @@ yyreduce:
   case 186:
 
 /* Line 1455 of yacc.c  */
-#line 906 "ntp_parser.y"
+#line 913 "ntp_parser.y"
     { enqueue(cfgt.setvar, (yyvsp[(2) - (2)].Set_var)); }
     break;
 
   case 187:
 
 /* Line 1455 of yacc.c  */
-#line 908 "ntp_parser.y"
+#line 915 "ntp_parser.y"
     { enqueue(cfgt.trap, create_addr_opts_node((yyvsp[(2) - (2)].Address_node), NULL)); }
     break;
 
   case 188:
 
 /* Line 1455 of yacc.c  */
-#line 910 "ntp_parser.y"
+#line 917 "ntp_parser.y"
     { enqueue(cfgt.trap, create_addr_opts_node((yyvsp[(2) - (3)].Address_node), (yyvsp[(3) - (3)].Queue))); }
     break;
 
   case 189:
 
 /* Line 1455 of yacc.c  */
-#line 912 "ntp_parser.y"
+#line 919 "ntp_parser.y"
     { append_queue(cfgt.ttl, (yyvsp[(2) - (2)].Queue)); }
     break;
 
   case 190:
 
 /* Line 1455 of yacc.c  */
-#line 914 "ntp_parser.y"
+#line 921 "ntp_parser.y"
     { enqueue(cfgt.qos, create_attr_sval((yyvsp[(1) - (2)].Integer), (yyvsp[(2) - (2)].String))); }
     break;
 
   case 191:
 
 /* Line 1455 of yacc.c  */
-#line 919 "ntp_parser.y"
-    { enqueue(cfgt.vars, create_attr_sval(T_Driftfile, (yyvsp[(1) - (1)].String))); }
+#line 926 "ntp_parser.y"
+    {
+			if (input_from_file) {
+				enqueue(cfgt.vars, create_attr_sval(T_Driftfile, (yyvsp[(1) - (1)].String)));
+			} else {
+				free((yyvsp[(1) - (1)].String));
+				yyerror("driftfile remote configuration ignored");
+			}
+		}
     break;
 
   case 192:
 
 /* Line 1455 of yacc.c  */
-#line 921 "ntp_parser.y"
-    { enqueue(cfgt.vars, create_attr_dval(T_WanderThreshold, (yyvsp[(2) - (2)].Double)));
-			  enqueue(cfgt.vars, create_attr_sval(T_Driftfile, (yyvsp[(1) - (2)].String))); }
+#line 935 "ntp_parser.y"
+    {
+			if (input_from_file) {
+				enqueue(cfgt.vars, create_attr_dval(T_WanderThreshold, (yyvsp[(2) - (2)].Double)));
+				enqueue(cfgt.vars, create_attr_sval(T_Driftfile, (yyvsp[(1) - (2)].String)));
+			} else {
+				free((yyvsp[(1) - (2)].String));
+				yyerror("driftfile remote configuration ignored");
+			}
+		}
     break;
 
   case 193:
 
 /* Line 1455 of yacc.c  */
-#line 924 "ntp_parser.y"
-    { enqueue(cfgt.vars, create_attr_sval(T_Driftfile, "\0")); }
+#line 945 "ntp_parser.y"
+    {
+			if (input_from_file) {
+				enqueue(cfgt.vars, create_attr_sval(T_Driftfile, "\0"));
+			} else {
+				yyerror("driftfile remote configuration ignored");
+			}
+		}
     break;
 
   case 194:
 
 /* Line 1455 of yacc.c  */
-#line 929 "ntp_parser.y"
+#line 956 "ntp_parser.y"
     { (yyval.Set_var) = create_setvar_node((yyvsp[(1) - (4)].String), (yyvsp[(3) - (4)].String), (yyvsp[(4) - (4)].Integer)); }
     break;
 
   case 195:
 
 /* Line 1455 of yacc.c  */
-#line 931 "ntp_parser.y"
+#line 958 "ntp_parser.y"
     { (yyval.Set_var) = create_setvar_node((yyvsp[(1) - (3)].String), (yyvsp[(3) - (3)].String), 0); }
     break;
 
   case 196:
 
 /* Line 1455 of yacc.c  */
-#line 936 "ntp_parser.y"
+#line 963 "ntp_parser.y"
     { (yyval.Queue) = enqueue((yyvsp[(1) - (2)].Queue), (yyvsp[(2) - (2)].Attr_val)); }
     break;
 
   case 197:
 
 /* Line 1455 of yacc.c  */
-#line 937 "ntp_parser.y"
+#line 964 "ntp_parser.y"
     { (yyval.Queue) = enqueue_in_new_queue((yyvsp[(1) - (1)].Attr_val)); }
     break;
 
   case 198:
 
 /* Line 1455 of yacc.c  */
-#line 941 "ntp_parser.y"
+#line 968 "ntp_parser.y"
     { (yyval.Attr_val) = create_attr_ival((yyvsp[(1) - (2)].Integer), (yyvsp[(2) - (2)].Integer)); }
     break;
 
   case 199:
 
 /* Line 1455 of yacc.c  */
-#line 942 "ntp_parser.y"
+#line 969 "ntp_parser.y"
     { (yyval.Attr_val) = create_attr_pval((yyvsp[(1) - (2)].Integer), (yyvsp[(2) - (2)].Address_node)); }
     break;
 
   case 200:
 
 /* Line 1455 of yacc.c  */
-#line 946 "ntp_parser.y"
+#line 973 "ntp_parser.y"
     { (yyval.Queue) = enqueue((yyvsp[(1) - (2)].Queue), (yyvsp[(2) - (2)].Attr_val)); }
     break;
 
   case 201:
 
 /* Line 1455 of yacc.c  */
-#line 947 "ntp_parser.y"
+#line 974 "ntp_parser.y"
     { (yyval.Queue) = enqueue_in_new_queue((yyvsp[(1) - (1)].Attr_val)); }
     break;
 
   case 202:
 
 /* Line 1455 of yacc.c  */
-#line 952 "ntp_parser.y"
+#line 979 "ntp_parser.y"
     {
 			char prefix = (yyvsp[(1) - (1)].String)[0];
 			char *type = (yyvsp[(1) - (1)].String) + 1;
@@ -3380,7 +3407,7 @@ yyreduce:
   case 203:
 
 /* Line 1455 of yacc.c  */
-#line 967 "ntp_parser.y"
+#line 994 "ntp_parser.y"
     {
 			enqueue(cfgt.nic_rules,
 				create_nic_rule_node((yyvsp[(3) - (3)].Integer), NULL, (yyvsp[(2) - (3)].Integer)));
@@ -3390,7 +3417,7 @@ yyreduce:
   case 204:
 
 /* Line 1455 of yacc.c  */
-#line 972 "ntp_parser.y"
+#line 999 "ntp_parser.y"
     {
 			enqueue(cfgt.nic_rules,
 				create_nic_rule_node(0, (yyvsp[(3) - (3)].String), (yyvsp[(2) - (3)].Integer)));
@@ -3400,77 +3427,77 @@ yyreduce:
   case 214:
 
 /* Line 1455 of yacc.c  */
-#line 1003 "ntp_parser.y"
+#line 1030 "ntp_parser.y"
     { (yyval.Queue) = enqueue((yyvsp[(1) - (2)].Queue), create_ival((yyvsp[(2) - (2)].Integer))); }
     break;
 
   case 215:
 
 /* Line 1455 of yacc.c  */
-#line 1004 "ntp_parser.y"
+#line 1031 "ntp_parser.y"
     { (yyval.Queue) = enqueue_in_new_queue(create_ival((yyvsp[(1) - (1)].Integer))); }
     break;
 
   case 216:
 
 /* Line 1455 of yacc.c  */
-#line 1009 "ntp_parser.y"
+#line 1036 "ntp_parser.y"
     { (yyval.Queue) = enqueue((yyvsp[(1) - (2)].Queue), (yyvsp[(2) - (2)].Attr_val)); }
     break;
 
   case 217:
 
 /* Line 1455 of yacc.c  */
-#line 1011 "ntp_parser.y"
+#line 1038 "ntp_parser.y"
     { (yyval.Queue) = enqueue_in_new_queue((yyvsp[(1) - (1)].Attr_val)); }
     break;
 
   case 218:
 
 /* Line 1455 of yacc.c  */
-#line 1016 "ntp_parser.y"
+#line 1043 "ntp_parser.y"
     { (yyval.Attr_val) = create_attr_ival('i', (yyvsp[(1) - (1)].Integer)); }
     break;
 
   case 220:
 
 /* Line 1455 of yacc.c  */
-#line 1022 "ntp_parser.y"
+#line 1049 "ntp_parser.y"
     { (yyval.Attr_val) = create_attr_shorts('-', (yyvsp[(2) - (5)].Integer), (yyvsp[(4) - (5)].Integer)); }
     break;
 
   case 221:
 
 /* Line 1455 of yacc.c  */
-#line 1026 "ntp_parser.y"
+#line 1053 "ntp_parser.y"
     { (yyval.Queue) = enqueue((yyvsp[(1) - (2)].Queue), create_pval((yyvsp[(2) - (2)].String))); }
     break;
 
   case 222:
 
 /* Line 1455 of yacc.c  */
-#line 1027 "ntp_parser.y"
+#line 1054 "ntp_parser.y"
     { (yyval.Queue) = enqueue_in_new_queue(create_pval((yyvsp[(1) - (1)].String))); }
     break;
 
   case 223:
 
 /* Line 1455 of yacc.c  */
-#line 1031 "ntp_parser.y"
+#line 1058 "ntp_parser.y"
     { (yyval.Queue) = enqueue((yyvsp[(1) - (2)].Queue), (yyvsp[(2) - (2)].Address_node)); }
     break;
 
   case 224:
 
 /* Line 1455 of yacc.c  */
-#line 1032 "ntp_parser.y"
+#line 1059 "ntp_parser.y"
     { (yyval.Queue) = enqueue_in_new_queue((yyvsp[(1) - (1)].Address_node)); }
     break;
 
   case 225:
 
 /* Line 1455 of yacc.c  */
-#line 1037 "ntp_parser.y"
+#line 1064 "ntp_parser.y"
     {
 			if ((yyvsp[(1) - (1)].Integer) != 0 && (yyvsp[(1) - (1)].Integer) != 1) {
 				yyerror("Integer value is not boolean (0 or 1). Assuming 1");
@@ -3484,28 +3511,28 @@ yyreduce:
   case 226:
 
 /* Line 1455 of yacc.c  */
-#line 1045 "ntp_parser.y"
+#line 1072 "ntp_parser.y"
     { (yyval.Integer) = 1; }
     break;
 
   case 227:
 
 /* Line 1455 of yacc.c  */
-#line 1046 "ntp_parser.y"
+#line 1073 "ntp_parser.y"
     { (yyval.Integer) = 0; }
     break;
 
   case 228:
 
 /* Line 1455 of yacc.c  */
-#line 1050 "ntp_parser.y"
+#line 1077 "ntp_parser.y"
     { (yyval.Double) = (double)(yyvsp[(1) - (1)].Integer); }
     break;
 
   case 230:
 
 /* Line 1455 of yacc.c  */
-#line 1061 "ntp_parser.y"
+#line 1088 "ntp_parser.y"
     {
 			cfgt.sim_details = create_sim_node((yyvsp[(3) - (5)].Queue), (yyvsp[(4) - (5)].Queue));
 
@@ -3517,147 +3544,147 @@ yyreduce:
   case 231:
 
 /* Line 1455 of yacc.c  */
-#line 1075 "ntp_parser.y"
+#line 1102 "ntp_parser.y"
     { old_config_style = 0; }
     break;
 
   case 232:
 
 /* Line 1455 of yacc.c  */
-#line 1079 "ntp_parser.y"
+#line 1106 "ntp_parser.y"
     { (yyval.Queue) = enqueue((yyvsp[(1) - (3)].Queue), (yyvsp[(2) - (3)].Attr_val)); }
     break;
 
   case 233:
 
 /* Line 1455 of yacc.c  */
-#line 1080 "ntp_parser.y"
+#line 1107 "ntp_parser.y"
     { (yyval.Queue) = enqueue_in_new_queue((yyvsp[(1) - (2)].Attr_val)); }
     break;
 
   case 234:
 
 /* Line 1455 of yacc.c  */
-#line 1084 "ntp_parser.y"
+#line 1111 "ntp_parser.y"
     { (yyval.Attr_val) = create_attr_dval((yyvsp[(1) - (3)].Integer), (yyvsp[(3) - (3)].Double)); }
     break;
 
   case 235:
 
 /* Line 1455 of yacc.c  */
-#line 1085 "ntp_parser.y"
+#line 1112 "ntp_parser.y"
     { (yyval.Attr_val) = create_attr_dval((yyvsp[(1) - (3)].Integer), (yyvsp[(3) - (3)].Double)); }
     break;
 
   case 236:
 
 /* Line 1455 of yacc.c  */
-#line 1089 "ntp_parser.y"
+#line 1116 "ntp_parser.y"
     { (yyval.Queue) = enqueue((yyvsp[(1) - (2)].Queue), (yyvsp[(2) - (2)].Sim_server)); }
     break;
 
   case 237:
 
 /* Line 1455 of yacc.c  */
-#line 1090 "ntp_parser.y"
+#line 1117 "ntp_parser.y"
     { (yyval.Queue) = enqueue_in_new_queue((yyvsp[(1) - (1)].Sim_server)); }
     break;
 
   case 238:
 
 /* Line 1455 of yacc.c  */
-#line 1095 "ntp_parser.y"
+#line 1122 "ntp_parser.y"
     { (yyval.Sim_server) = create_sim_server((yyvsp[(1) - (5)].Address_node), (yyvsp[(3) - (5)].Double), (yyvsp[(4) - (5)].Queue)); }
     break;
 
   case 239:
 
 /* Line 1455 of yacc.c  */
-#line 1099 "ntp_parser.y"
+#line 1126 "ntp_parser.y"
     { (yyval.Double) = (yyvsp[(3) - (4)].Double); }
     break;
 
   case 240:
 
 /* Line 1455 of yacc.c  */
-#line 1103 "ntp_parser.y"
+#line 1130 "ntp_parser.y"
     { (yyval.Address_node) = (yyvsp[(3) - (3)].Address_node); }
     break;
 
   case 241:
 
 /* Line 1455 of yacc.c  */
-#line 1107 "ntp_parser.y"
+#line 1134 "ntp_parser.y"
     { (yyval.Queue) = enqueue((yyvsp[(1) - (2)].Queue), (yyvsp[(2) - (2)].Sim_script)); }
     break;
 
   case 242:
 
 /* Line 1455 of yacc.c  */
-#line 1108 "ntp_parser.y"
+#line 1135 "ntp_parser.y"
     { (yyval.Queue) = enqueue_in_new_queue((yyvsp[(1) - (1)].Sim_script)); }
     break;
 
   case 243:
 
 /* Line 1455 of yacc.c  */
-#line 1113 "ntp_parser.y"
+#line 1140 "ntp_parser.y"
     { (yyval.Sim_script) = create_sim_script_info((yyvsp[(3) - (6)].Double), (yyvsp[(5) - (6)].Queue)); }
     break;
 
   case 244:
 
 /* Line 1455 of yacc.c  */
-#line 1117 "ntp_parser.y"
+#line 1144 "ntp_parser.y"
     { (yyval.Queue) = enqueue((yyvsp[(1) - (3)].Queue), (yyvsp[(2) - (3)].Attr_val)); }
     break;
 
   case 245:
 
 /* Line 1455 of yacc.c  */
-#line 1118 "ntp_parser.y"
+#line 1145 "ntp_parser.y"
     { (yyval.Queue) = enqueue_in_new_queue((yyvsp[(1) - (2)].Attr_val)); }
     break;
 
   case 246:
 
 /* Line 1455 of yacc.c  */
-#line 1123 "ntp_parser.y"
+#line 1150 "ntp_parser.y"
     { (yyval.Attr_val) = create_attr_dval((yyvsp[(1) - (3)].Integer), (yyvsp[(3) - (3)].Double)); }
     break;
 
   case 247:
 
 /* Line 1455 of yacc.c  */
-#line 1125 "ntp_parser.y"
+#line 1152 "ntp_parser.y"
     { (yyval.Attr_val) = create_attr_dval((yyvsp[(1) - (3)].Integer), (yyvsp[(3) - (3)].Double)); }
     break;
 
   case 248:
 
 /* Line 1455 of yacc.c  */
-#line 1127 "ntp_parser.y"
+#line 1154 "ntp_parser.y"
     { (yyval.Attr_val) = create_attr_dval((yyvsp[(1) - (3)].Integer), (yyvsp[(3) - (3)].Double)); }
     break;
 
   case 249:
 
 /* Line 1455 of yacc.c  */
-#line 1129 "ntp_parser.y"
+#line 1156 "ntp_parser.y"
     { (yyval.Attr_val) = create_attr_dval((yyvsp[(1) - (3)].Integer), (yyvsp[(3) - (3)].Double)); }
     break;
 
   case 250:
 
 /* Line 1455 of yacc.c  */
-#line 1131 "ntp_parser.y"
+#line 1158 "ntp_parser.y"
     { (yyval.Attr_val) = create_attr_dval((yyvsp[(1) - (3)].Integer), (yyvsp[(3) - (3)].Double)); }
     break;
 
 
 
 /* Line 1455 of yacc.c  */
-#line 3661 "ntp_parser.c"
+#line 3688 "ntp_parser.c"
       default: break;
     }
   YY_SYMBOL_PRINT ("-> $$ =", yyr1[yyn], &yyval, &yyloc);
@@ -3869,7 +3896,7 @@ yyreturn:
 
 
 /* Line 1675 of yacc.c  */
-#line 1135 "ntp_parser.y"
+#line 1162 "ntp_parser.y"
 
 
 void yyerror (char *msg)
